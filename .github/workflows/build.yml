name: Build & Deploy RSS feed

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build feed (robust)
        run: |
          set -euxo pipefail
          node -v
          mkdir -p dist

          # Try the real build first
          if node scripts/build-feed.mjs; then
            echo "✅ build-feed.mjs completed"
          else
            echo "❌ build-feed.mjs failed — creating a minimal fallback feed" >&2
            NOW=$(date -uR)
            cat > dist/feed.xml <<'XML'
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
  xmlns:media="http://search.yahoo.com/mrss/"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:dc="http://purl.org/dc/elements/1.1/"
  xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <atom:link href="https://CTV-Clearlink.github.io/RSS-Feed/feed.xml" rel="self" type="application/rss+xml" />
    <title>CTV Feed (Fallback)</title>
    <link>https://www.cabletv.com/</link>
    <description>Fallback feed written by workflow because build script failed.</description>
    <lastBuildDate>NOW_PLACEHOLDER</lastBuildDate>
    <item>
      <title><![CDATA[Build failed on GitHub Actions]]></title>
      <link>https://CTV-Clearlink.github.io/RSS-Feed/feed.xml</link>
      <guid isPermaLink="false">build-failed</guid>
      <pubDate>NOW_PLACEHOLDER</pubDate>
      <description><![CDATA[Open the workflow logs → “Build feed (robust)” to see the error.]]></description>
      <content:encoded><![CDATA[<p>Check the Actions logs for error details.</p>]]></content:encoded>
    </item>
  </channel>
</rss>
XML
            sed -i "s/NOW_PLACEHOLDER/$NOW/g" dist/feed.xml
          fi

          echo "== head of dist/feed.xml =="
          head -n 60 dist/feed.xml

          # Make sure Jekyll doesn't rewrite anything
          touch dist/.nojekyll

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
