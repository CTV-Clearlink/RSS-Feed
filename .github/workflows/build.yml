name: Clean RSS â†’ GitHub Pages (no Node)

on:
  push:                # run on any branch so we don't miss your default
  workflow_dispatch:   # manual "Run workflow" button

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  SOURCE_FEED: "http://www.cabletv.com/blog/feed"
  SELF_URL: "https://CTV-Clearlink.github.io/RSS-Feed/feed.xml"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Required for Pages
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Build cleaned feed (bash + perl only)
        run: |
          set -euo pipefail
          mkdir -p dist

          echo "== fetch source =="
          UA='Mozilla/5.0 (compatible; CleanFeed/1.0)'
          curl -fsSL -A "$UA" -H 'Accept: application/rss+xml, application/xml;q=0.9, */*;q=0.8' "$SOURCE_FEED" -o src.xml

          # normalize newlines
          tr -d '\r' < src.xml > work.xml

          echo "== sanitize =="
          # 1) remove SmartNews namespace + elements (multi-line safe)
          perl -0777 -pe 's/\s+xmlns:snf="[^"]*"//gi' work.xml \
          | perl -0777 -pe 's#<snf:[^>]+>.*?</snf:[^>]+>##gis' \
          | perl -0777 -pe 's#<snf:[^>]*/>##gis' \
          # 2) normalize <rss ...> to standard namespaces only
          | perl -0777 -pe 's#<\?xml[^>]*\?>\s*<rss[^>]*>#<?xml version="1.0" encoding="UTF-8"?>\n<rss version="2.0"\n  xmlns:media="http://search.yahoo.com/mrss/"\n  xmlns:content="http://purl.org/rss/1.0/modules/content/"\n  xmlns:dc="http://purl.org/dc/elements/1.1/"\n  xmlns:atom="http://www.w3.org/2005/Atom">#is' \
          # 3) remove any existing rel=self
          | perl -0777 -pe 's#<atom:link[^>]+rel=(?:"|\')self(?:"|\')[^>]*/>\s*##is' \
          # 4) inject our exact rel=self after <channel>
          | perl -0777 -pe "s#(<channel[^>]*>)#\$1\n    <atom:link href=\"$ENV{SELF_URL}\" rel=\"self\" type=\"application/rss+xml\" />#i" \
          # 5) drop all <content:encoded> blocks (validator HTML issues)
          | perl -0777 -pe 's#<content:encoded\b[^>]*>.*?</content:encoded>##gis' \
          > dist/feed.xml

          echo "== head of output =="
          head -n 40 dist/feed.xml || true

          # prevent Jekyll mangling
          touch dist/.nojekyll

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
